<div id="event-content" class="content ng-scope" ng-controller="EventCtrl">
    <form class="form" name="form">
        @Html.AntiForgeryToken()
		
        <input id="Longitude" name="Longitude" type="hidden" value="{{theEvent.position.nb}}" />
        <input id="Latitude" name="Latitude" type="hidden" value="{{theEvent.position.mb}}" />
    
        <div class="row-fluid">
            <div class="span6">
                <fieldset>
                    <legend class="geek">Enter details to create a new event</legend>
                    <textarea rows="4" ng-model="model.Description" placeholder="Description" required class="input-xxlarge input-block-level"></textarea>
                    <input type="datetime" ng-model="model.Date" class="input-xxlarge input-block-level" placeholder="Date and time" required/>
                    <input type="text" ng-model="model.Venue" class="input-xxlarge input-block-level" placeholder="Venue" required />
                    <div id="map-canvas" ui-map="eventMap" class="map"
                         ui-event="{'map-click': 'moveMarker($event)' }"
                         ui-options="mapOptions">
                    </div>
                    <br/>
                    <button ng-show="!model.ReadOnly" class="btn" type="submit" ng-click="submit()">Save</button>
                </fieldset>
                
            </div>
            <div class="span6">
                <fieldset>
                    <legend class="geek">Who's invited</legend>
                    <friend-picker></friend-picker>
                </fieldset>
            </div>
        </div>
    </form>
</div>

@section scripts{
    <script src="/geeks/js/ranking.js" type="text/javascript"> </script>
    <script type="text/javascript">
        $("#nav-bar li.active").removeClass("active");
        $("#events-nav").addClass("active");

        function EventCtrl($scope, $http, xsrfPost) {
            $scope.zoom = 12;
            $scope.eventId = "@ViewBag.EventId";

            $scope.mapOptions = {
                center: new google.maps.LatLng(51.509, -0.115),
                zoom: $scope.zoom,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };

            $scope.moveMarker = function($event) {
                console.log("moving marker to " + $event.latLng);
                $scope.theEvent.setPosition($event.latLng);
                console.log("Lat: " + $scope.theEvent.position.lat());
                console.log("Long: " + $scope.theEvent.position.lng());
            };

            $scope.setMarkerPosition = function(marker, lat, lng) {
                marker.setPosition(new google.maps.LatLng(lat, lng));
            };

            $scope.submit = function() {
                if ($scope.form.$valid) {
                    xsrfPost.post("/geeks/Home/SaveEvent", {
                        model: {
                            Id : $scope.eventId,
                            Description: $scope.model.Description,
                            Latitude: $scope.theEvent.position.lat(),
                            Longitude: $scope.theEvent.position.lng(),
                            Venue: $scope.model.Venue,
                            Invitations: $scope.model.Invitations,
                            CreatedBy:$scope.model.CreatedBy
                        }
                    }).success(function() {
                        console.log("saved changes to " + $scope.eventId);
                    });
                }
            };

            $http.get("/geeks/Home/EventData/" + $scope.eventId).success(function(data, status) {
				$scope.model = data;
                $scope.eventId = data.Id;
                var latlng = new google.maps.LatLng(data.Latitude, data.Longitude);
                $scope.theEvent = new google.maps.Marker({
                    map: $scope.eventMap,
                    position: latlng
                });
                $scope.eventMap.panTo($scope.theEvent.getPosition());
            });

        }
    </script>
}